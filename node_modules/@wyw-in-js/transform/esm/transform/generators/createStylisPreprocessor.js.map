{"version":3,"file":"createStylisPreprocessor.js","names":["path","compile","middleware","prefixer","serialize","stringify","tokenize","RULESET","KEYFRAMES","DECLARATION","POSIX_SEP","posix","sep","transformUrl","url","outputFilename","sourceFilename","platformPath","relative","dirname","resolve","split","join","DEFINED_KEYFRAMES","Symbol","ORIGINAL_VALUE_KEY","IS_GLOBAL_KEYFRAMES","getOriginalElementValue","element","value","throwIfNotProd","key","type","process","env","NODE_ENV","Error","JSON","childrenIsString","children","propsAreStrings","props","Array","isArray","propsIsString","isDeclaration","isKeyframes","isRuleset","stylisGlobalPlugin","getGlobalSelectorModifiers","el","parent","parentValue","length","includes","match","baseSelector","spaceDelimiter","includeBaseSelector","includeSpaceDelimiter","Object","assign","map","cssSelector","tokens","selector","i","len","token","slice","createStylisUrlReplacePlugin","filename","return","replace","_match","p1","_p2","p3","p4","createKeyframeSuffixerPlugin","prefixes","getPrefixedProp","prop","prefix","buildPropsRegexp","isAtRule","at","colon","RegExp","animationNameRegexp","getReplacer","startsWith","searchValue","replacer","input","fullMatch","undefined","rest","elementToKeyframeSuffix","replaceAll","animationPropsSet","Set","getDefinedKeyframes","keyframes","sibling","siblings","add","suffix","replaceFn","globalMatch","scopedMatch","keys","has","scopedKeyframes","patch","fromEntries","result","globalName","substring","isMiddleware","obj","createStylisPreprocessor","options","stylisPreprocess","text","compiled","filter"],"sources":["../../../src/transform/generators/createStylisPreprocessor.ts"],"sourcesContent":["/* eslint-disable no-continue */\nimport * as path from 'path';\nimport {\n  compile,\n  middleware,\n  prefixer,\n  serialize,\n  stringify,\n  tokenize,\n  RULESET,\n  KEYFRAMES,\n  DECLARATION,\n} from 'stylis';\nimport type { Middleware, Element } from 'stylis';\n\nimport type { Options } from '../../types';\n\nconst POSIX_SEP = path.posix.sep;\n\nexport function transformUrl(\n  url: string,\n  outputFilename: string,\n  sourceFilename: string,\n  platformPath: typeof path = path\n) {\n  // Replace asset path with new path relative to the output CSS\n  const relative = platformPath.relative(\n    platformPath.dirname(outputFilename),\n    // Get the absolute path to the asset from the path relative to the JS file\n    platformPath.resolve(platformPath.dirname(sourceFilename), url)\n  );\n\n  if (platformPath.sep === POSIX_SEP) {\n    return relative;\n  }\n\n  return relative.split(platformPath.sep).join(POSIX_SEP);\n}\n\ninterface IGlobalSelectorModifiers {\n  includeBaseSelector: boolean;\n  includeSpaceDelimiter: boolean;\n}\n\nconst DEFINED_KEYFRAMES = Symbol('definedKeyframes');\nconst ORIGINAL_VALUE_KEY = Symbol('originalValue');\nconst IS_GLOBAL_KEYFRAMES = Symbol('isGlobalKeyframes');\n\nconst getOriginalElementValue = (\n  element: (Element & { [ORIGINAL_VALUE_KEY]?: string }) | null\n) => {\n  return element ? element[ORIGINAL_VALUE_KEY] ?? element.value : '';\n};\n\nfunction throwIfNotProd(key: string, value: unknown, type: string): false {\n  if (process.env.NODE_ENV !== 'production') {\n    throw new Error(\n      `\"element.${key}\" has type \"${type}\" (${JSON.stringify(\n        value,\n        null,\n        2\n      )}), it's not expected. Please report a bug if it happens.`\n    );\n  }\n\n  return false;\n}\n\ntype SpecificElement<TFields> = Omit<Element, keyof TFields> & TFields;\ntype Declaration = SpecificElement<{\n  children: string;\n  props: string;\n  type: typeof DECLARATION;\n}>;\ntype Keyframes = SpecificElement<{\n  [IS_GLOBAL_KEYFRAMES]?: boolean;\n  props: string[];\n  type: typeof KEYFRAMES;\n}>;\ntype Ruleset = SpecificElement<{\n  props: string[];\n  type: typeof RULESET;\n}>;\n\nfunction childrenIsString(children: string | Element[]): children is string {\n  return (\n    typeof children === 'string' ||\n    throwIfNotProd('children', children, 'Element[]')\n  );\n}\n\nfunction propsAreStrings(props: string | string[]): props is string[] {\n  return Array.isArray(props) || throwIfNotProd('props', props, 'string');\n}\n\nfunction propsIsString(props: string | string[]): props is string {\n  return (\n    typeof props === 'string' || throwIfNotProd('props', props, 'string[]')\n  );\n}\n\nconst isDeclaration = (element: Element): element is Declaration => {\n  return (\n    element.type === DECLARATION &&\n    propsIsString(element.props) &&\n    childrenIsString(element.children)\n  );\n};\n\nconst isKeyframes = (element: Element): element is Keyframes => {\n  return element.type === KEYFRAMES && propsAreStrings(element.props);\n};\n\nconst isRuleset = (element: Element): element is Ruleset => {\n  return element.type === RULESET && propsAreStrings(element.props);\n};\n\n/**\n * Stylis plugin that mimics :global() selector behavior from Stylis v3.\n */\nexport const stylisGlobalPlugin: Middleware = (element) => {\n  function getGlobalSelectorModifiers(el: Element): IGlobalSelectorModifiers {\n    const { parent } = el;\n\n    const value = getOriginalElementValue(el);\n    const parentValue = getOriginalElementValue(parent);\n\n    if (\n      (parent?.children.length === 0 && parentValue.includes(':global(')) ||\n      (parent && !value.includes(':global('))\n    ) {\n      return getGlobalSelectorModifiers(parent);\n    }\n\n    const match = value.match(/(&\\f( )?)?:global\\(/);\n\n    if (match === null) {\n      throw new Error(\n        `Failed to match :global() selector in \"${value}\". Please report a bug if it happens.`\n      );\n    }\n\n    const [, baseSelector, spaceDelimiter] = match;\n\n    return {\n      includeBaseSelector: !!baseSelector,\n      includeSpaceDelimiter: !!spaceDelimiter,\n    };\n  }\n\n  if (!isRuleset(element)) {\n    return;\n  }\n\n  Object.assign(element, {\n    props: element.props.map((cssSelector) => {\n      // The value can be changed by other middlewares, but we need an original one with `&`\n      Object.assign(element, { [ORIGINAL_VALUE_KEY]: element.value });\n\n      // Avoids calling tokenize() on every string\n      if (!cssSelector.includes(':global(')) {\n        return cssSelector;\n      }\n\n      if (element.children.length === 0) {\n        return cssSelector;\n      }\n\n      const { includeBaseSelector, includeSpaceDelimiter } =\n        getGlobalSelectorModifiers(element);\n\n      const tokens = tokenize(cssSelector);\n      let selector = '';\n\n      for (let i = 0, len = tokens.length; i < len; i++) {\n        const token = tokens[i];\n\n        //\n        // Match for \":global(\"\n        if (token === ':' && tokens[i + 1] === 'global') {\n          //\n          // Match for \":global()\"\n          if (tokens[i + 2] === '()') {\n            selector = [\n              ...tokens.slice(i + 4),\n              includeSpaceDelimiter ? ' ' : '',\n              ...(includeBaseSelector ? tokens.slice(0, i - 1) : []),\n              includeSpaceDelimiter ? '' : ' ',\n            ].join('');\n\n            break;\n          }\n\n          //\n          // Match for \":global(selector)\"\n          selector = [\n            tokens[i + 2].slice(1, -1),\n            includeSpaceDelimiter ? ' ' : '',\n            ...(includeBaseSelector ? tokens.slice(0, i - 1) : []),\n            includeSpaceDelimiter ? '' : ' ',\n          ].join('');\n\n          break;\n        }\n      }\n\n      return selector;\n    }),\n  });\n};\n\nexport function createStylisUrlReplacePlugin(\n  filename: string,\n  outputFilename: string | undefined\n): Middleware {\n  return (element) => {\n    if (element.type === 'decl' && outputFilename) {\n      // When writing to a file, we need to adjust the relative paths inside url(..) expressions.\n      // It'll allow css-loader to resolve an imported asset properly.\n      // eslint-disable-next-line no-param-reassign\n      element.return = element.value.replace(\n        /\\b(url\\(([\"']?))(\\.[^)]+?)(\\2\\))/g,\n        (_match, p1, _p2, p3, p4) =>\n          p1 + transformUrl(p3, outputFilename, filename) + p4\n      );\n    }\n  };\n}\n\nexport function createKeyframeSuffixerPlugin(): Middleware {\n  const prefixes = ['webkit', 'moz', 'ms', 'o', ''].map((i) =>\n    i ? `-${i}-` : ''\n  );\n\n  const getPrefixedProp = (prop: string): string[] =>\n    prefixes.map((prefix) => `${prefix}${prop}`);\n\n  const buildPropsRegexp = (prop: string, isAtRule: boolean) => {\n    const [at, colon] = isAtRule ? ['@', ''] : ['', ':'];\n    return new RegExp(\n      `^(${at}(?:${getPrefixedProp(prop).join('|')})${colon})\\\\s*`\n    );\n  };\n\n  const animationNameRegexp = /:global\\(([\\w_-]+)\\)|([\\w_-]+)/;\n\n  const getReplacer = (\n    startsWith: RegExp,\n    searchValue: RegExp,\n    replacer: (substring: string, ...matches: string[]) => string\n  ): ((input: string) => string) => {\n    return (input) => {\n      const [fullMatch] = input.match(startsWith) ?? [];\n      if (fullMatch === undefined) {\n        return input;\n      }\n\n      const rest = input.slice(fullMatch.length);\n      return fullMatch + rest.replace(searchValue, replacer);\n    };\n  };\n\n  const elementToKeyframeSuffix = (el: Element): string => {\n    if (el.parent) {\n      return elementToKeyframeSuffix(el.parent);\n    }\n\n    return el.value.replaceAll(/[^a-zA-Z0-9_-]/g, '');\n  };\n\n  const animationPropsSet = new Set([\n    ...getPrefixedProp('animation'),\n    ...getPrefixedProp('animation-name'),\n  ]);\n\n  const getDefinedKeyframes = (\n    element: Element & {\n      [DEFINED_KEYFRAMES]?: Set<string>;\n      siblings?: (Element & { [IS_GLOBAL_KEYFRAMES]?: boolean })[];\n    }\n  ): Set<string> => {\n    if (element[DEFINED_KEYFRAMES]) {\n      return element[DEFINED_KEYFRAMES];\n    }\n\n    if (element.parent) {\n      return getDefinedKeyframes(element.parent);\n    }\n\n    const keyframes = new Set<string>();\n    for (const sibling of element.siblings ?? []) {\n      if (!isKeyframes(sibling) || sibling[IS_GLOBAL_KEYFRAMES] === true) {\n        continue;\n      }\n\n      keyframes.add(sibling.props[0]);\n    }\n\n    Object.assign(element, { [DEFINED_KEYFRAMES]: keyframes });\n\n    return keyframes;\n  };\n\n  return (element) => {\n    if (isKeyframes(element) && element.parent) {\n      const suffix = elementToKeyframeSuffix(element);\n\n      const replaceFn = (\n        _match: string,\n        globalMatch: string,\n        scopedMatch: string\n      ): string => globalMatch || `${scopedMatch}-${suffix}`;\n\n      Object.assign(element, {\n        [IS_GLOBAL_KEYFRAMES]:\n          element.props[0]?.startsWith(':global(') ?? false,\n        props: element.props.map(\n          getReplacer(/^\\s*/, animationNameRegexp, replaceFn)\n        ),\n        value: getReplacer(\n          buildPropsRegexp('keyframes', true),\n          animationNameRegexp,\n          replaceFn\n        )(element.value),\n      });\n\n      return;\n    }\n\n    if (isDeclaration(element)) {\n      const suffix = elementToKeyframeSuffix(element);\n      const keys = [\n        'children',\n        'return',\n        'value',\n      ] satisfies (keyof Declaration)[];\n\n      if (animationPropsSet.has(element.props)) {\n        const scopedKeyframes = getDefinedKeyframes(element);\n        const patch = Object.fromEntries(\n          keys.map((key) => {\n            const tokens = tokenize(element[key]);\n            let result = '';\n            for (let i = 0; i < tokens.length; i += 1) {\n              if (\n                tokens[i] === ':' &&\n                tokens[i + 1] === 'global' &&\n                tokens[i + 2].startsWith('(')\n              ) {\n                const globalName = tokens[i + 2].substring(\n                  1,\n                  tokens[i + 2].length - 1\n                );\n                i += 2;\n\n                result += globalName;\n                if (tokens[i + 1] !== ';') {\n                  result += ' ';\n                }\n                continue;\n              }\n\n              if (scopedKeyframes.has(tokens[i])) {\n                result += `${tokens[i]}-${suffix}`;\n                continue;\n              }\n\n              result += tokens[i];\n            }\n\n            return [key, result];\n          })\n        );\n\n        Object.assign(element, patch);\n      }\n    }\n  };\n}\n\nconst isMiddleware = (obj: Middleware | null): obj is Middleware =>\n  obj !== null;\n\nexport function createStylisPreprocessor(\n  options: Options & { prefixer?: boolean }\n) {\n  function stylisPreprocess(selector: string, text: string): string {\n    const compiled = compile(`${selector} {${text}}\\n`);\n\n    return serialize(\n      compiled,\n      middleware(\n        [\n          createStylisUrlReplacePlugin(\n            options.filename,\n            options.outputFilename\n          ),\n          stylisGlobalPlugin,\n          options.prefixer === false ? null : prefixer,\n          createKeyframeSuffixerPlugin(),\n          stringify,\n        ].filter(isMiddleware)\n      )\n    );\n  }\n\n  return stylisPreprocess;\n}\n"],"mappings":"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"}
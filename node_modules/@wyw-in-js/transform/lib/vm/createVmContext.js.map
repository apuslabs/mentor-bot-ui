{"version":3,"file":"createVmContext.js","names":["vm","_interopRequireWildcard","require","_shared","process","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","prototype","hasOwnProperty","call","i","set","NOOP","createWindow","Window","GlobalWindow","HappyWindow","win","Buffer","Uint8Array","createBaseContext","additionalContext","baseContext","document","window","self","top","parent","global","clearImmediate","clearInterval","clearTimeout","setImmediate","requestAnimationFrame","setInterval","setTimeout","key","createHappyDOMWindow","teardown","happyDOM","cancelAsync","createNothing","undefined","createVmContext","filename","features","overrideContext","isHappyDOMEnabled","isFeatureEnabled","__filename","context","createContext"],"sources":["../../src/vm/createVmContext.ts"],"sourcesContent":["import * as vm from 'vm';\n\nimport type { Window } from 'happy-dom';\n\nimport type { FeatureFlags, StrictOptions } from '@wyw-in-js/shared';\nimport { isFeatureEnabled } from '@wyw-in-js/shared';\n\nimport * as process from './process';\n\nconst NOOP = () => {};\n\nfunction createWindow(): Window {\n  const { Window, GlobalWindow } = require('happy-dom');\n  const HappyWindow = GlobalWindow || Window;\n  const win = new HappyWindow();\n\n  // TODO: browser doesn't expose Buffer, but a lot of dependencies use it\n  win.Buffer = Buffer;\n  win.Uint8Array = Uint8Array;\n\n  return win;\n}\n\nfunction createBaseContext(\n  win: Window | undefined,\n  additionalContext: Partial<vm.Context>\n): Partial<vm.Context> {\n  const baseContext: vm.Context = win ?? {};\n\n  baseContext.document = win?.document;\n  baseContext.window = win;\n  baseContext.self = win;\n  baseContext.top = win;\n  baseContext.parent = win;\n  baseContext.global = win;\n\n  baseContext.process = process;\n\n  baseContext.clearImmediate = NOOP;\n  baseContext.clearInterval = NOOP;\n  baseContext.clearTimeout = NOOP;\n  baseContext.setImmediate = NOOP;\n  baseContext.requestAnimationFrame = NOOP;\n  baseContext.setInterval = NOOP;\n  baseContext.setTimeout = NOOP;\n\n  // eslint-disable-next-line guard-for-in,no-restricted-syntax\n  for (const key in additionalContext) {\n    baseContext[key] = additionalContext[key];\n  }\n\n  return baseContext;\n}\n\nfunction createHappyDOMWindow() {\n  const win = createWindow();\n\n  return {\n    teardown: () => {\n      win.happyDOM.cancelAsync();\n    },\n    window: win,\n  };\n}\n\nfunction createNothing() {\n  return {\n    teardown: () => {},\n    window: undefined,\n  };\n}\n\nexport function createVmContext(\n  filename: string,\n  features: FeatureFlags<'happyDOM'>,\n  additionalContext: Partial<vm.Context>,\n  overrideContext: StrictOptions['overrideContext'] = (i) => i\n) {\n  const isHappyDOMEnabled = isFeatureEnabled(features, 'happyDOM', filename);\n\n  const { teardown, window } = isHappyDOMEnabled\n    ? createHappyDOMWindow()\n    : createNothing();\n  const baseContext = createBaseContext(\n    window,\n    overrideContext(\n      {\n        __filename: filename,\n        ...additionalContext,\n      },\n      filename\n    )\n  );\n\n  const context = vm.createContext(baseContext);\n\n  return {\n    context,\n    teardown,\n  };\n}\n"],"mappings":"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"}